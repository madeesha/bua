{
  "name": "BUA Restore",
  "this": "000_restore_database",
  "retry_delay": 120,
  "data": {
    "domain": "cmil2mssslzz.ap-southeast-2.rds.amazonaws.com",
    "instance_class": "DBInstanceClassR6i",
    "instance_type": "8xlarge",
    "mysql_version": "8.0.32",
    "params_id": "1",
    "schema": "Turkey_BLU",
    "snapshot_arn": "arn:aws:rds:ap-southeast-2:561082505378:snapshot:tst-anstead-12-bua-sql-mysql8-0-32",
    "suffix": "bua-sql",
    "update_id": "12",
    "rdssecret": "cicd/tst-anstead/rds/bua",
    "hosted_zone_id": "Z06477101FOH3N8B2WK6N",
    "cluster_name": "anstead",
    "node_group_name": "managed-ng-anstead-demand-1-22-v20230914"
  },
  "steps": {
    "180_clear_error_queues": {
      "action": "empty_site_errors_queues",
      "on": {
        "COMPLETE": {
          "delay": 60,
          "next": "180_execute_micro_scalar"
        }
      }
    },
    "180_execute_micro_scalar": {
      "comment": "Generate micro scalar values",
      "action": "bua_initiate",
      "speed": "slow",
      "args": {
        "run_type": "MicroScalar",
        "identifier_type": "SegmentJurisdictionAvgExclEst"
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "180_wait_for_execute_micro_scalar"
        }
      }
    },
    "180_wait_for_execute_micro_scalar": {
      "action": "wait_for_empty_site_queues",
      "retry_delay": 120,
      "on": {
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "190_scale_up_nodegroup": {
      "action": "scale_nodegroup",
      "args": {
        "min_size": 10,
        "max_size": 10,
        "desired_size": 10
      },
      "on": {
        "RUNNING": {
          "next": "191_wait_for_scale_up_nodegroup"
        },
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 300
        }
      }
    },
    "191_wait_for_scale_up_nodegroup": {
      "action": "wait_for_scale_nodegroup",
      "on": {
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 300
        }
      }
    },
    "195_scale_up_meterdata": {
      "comment": "kubectl -n core scale --replicas=6 deployment meterdata",
      "action": "scale_replicas",
      "args": {
        "namespace": "core",
        "deployment": [
          "meterdata"
        ],
        "replicas": 8
      },
      "on": {
        "COMPLETE": {
          "delay": 60,
          "next": "195_wait_for_scale_up_meterdata"
        }
      }
    },
    "195_wait_for_scale_up_meterdata": {
      "action": "check_replicas",
      "args": {
        "namespace": "core",
        "deployment": [
          "meterdata"
        ],
        "replicas": 8
      },
      "on": {
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "200_clear_error_queues": {
      "action": "empty_site_errors_queues",
      "on": {
        "COMPLETE": {
          "delay": 60,
          "next": "200_generate_NEM12_files"
        }
      }
    },
    "200_generate_NEM12_files": {
      "comment": "Generate the missing electricity interval reads",
      "action": "bua_initiate",
      "args": {
        "run_type": "NEM12",
        "identifier_type": "SegmentJurisdictionAvgExclEst"
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "200_wait_for_generate_NEM12_files_1"
        }
      }
    },
    "200_wait_for_generate_NEM12_files_1": {
      "action": "wait_for_empty_site_queues",
      "retry_delay": 120,
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "201_wait_for_generate_NEM12_files_2"
        }
      }
    },
    "201_wait_for_generate_NEM12_files_2": {
      "comment": "Wait until the aggregation workflows are complete",
      "action": "wait_for_workflows",
      "retry_delay": 120,
      "args": {
        "workflow_names": [
          "ImportNem",
          "ImportGas",
          "AggregateReadNmiDate",
          "RegenerateProfile",
          "ValidateNEM13Read"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120
        },
        "FAILED": {
          "comment": "Stop processing"
        },
        "ONHOLD": {
          "comment": "Stop processing"
        }
      }
    },
    "210_clear_error_queues": {
      "action": "empty_site_errors_queues",
      "on": {
        "COMPLETE": {
          "delay": 60,
          "next": "210_reset_missing_basic_reads"
        }
      }
    },
    "210_reset_missing_basic_reads": {
      "comment": "Reset all of the missing basic reads",
      "action": "bua_initiate",
      "speed": "slow",
      "args": {
        "run_type": "ResetBasicRead",
        "identifier_type": "SegmentJurisdictionAvgExclEst"
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "210_wait_for_reset_missing_basic_reads"
        }
      }
    },
    "210_wait_for_reset_missing_basic_reads": {
      "action": "wait_for_empty_site_queues",
      "retry_delay": 120,
      "on": {
        "FAILED": {
          "comment": "Stop processing"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "220_clear_error_queues": {
      "action": "empty_site_errors_queues",
      "on": {
        "COMPLETE": {
          "delay": 60,
          "next": "220_generate_missing_basic_reads"
        }
      }
    },
    "220_generate_missing_basic_reads": {
      "comment": "Generate all of the missing basic reads",
      "action": "bua_initiate",
      "speed": "slow",
      "args": {
        "run_type": "BasicRead",
        "identifier_type": "SegmentJurisdictionAvgExclEst"
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "220_wait_for_generate_missing_basic_reads"
        }
      }
    },
    "220_wait_for_generate_missing_basic_reads": {
      "action": "wait_for_empty_site_queues",
      "retry_delay": 120,
      "on": {
        "FAILED": {
          "comment": "Terminate pipeline"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "230_prepare_invoice_runs": {
      "action": "execute_sql",
      "args": {
        "sql": [
          "UPDATE Workflows SET priority = 'XHIGH' WHERE name = 'GENERATE_ILI'",
          "UPDATE Workflows SET priority = 'HIGH' WHERE name = 'RUN_INVOICE_BATCH'",
          "UPDATE Workflows SET priority = 'NORMAL' WHERE name = 'INVOICEGEN'"
        ]
      },
      "on": {
        "COMPLETE": {
          "next": "230_invoice_runs"
        }
      }
    },
    "230_invoice_runs": {
      "comment": "Initiate the invoice runs",
      "action": "bua_initiate_invoice_runs",
      "speed": "slow",
      "args": {
        "num_groups": 16,
        "num_batches": 90,
        "concurrent_batches": 18,
        "schedule_gap": 1,
        "min_days": 1
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "230_wait_for_invoice_runs"
        }
      }
    },
    "230_wait_for_invoice_runs": {
      "action": "wait_for_workflow_schedules",
      "args": {
        "workflow_names": [
          "GENERATE_ILI"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "231_wait_for_invoice_runs"
        }
      }
    },
    "231_wait_for_invoice_runs": {
      "comment": "Wait until all invoicing runs are complete",
      "action": "wait_for_workflows",
      "retry_delay": 120,
      "args": {
        "workflow_names": [
          "GENERATE_ILI"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "232_wait_for_invoice_runs"
        },
        "FAILED": {
          "comment": "Stop processing"
        },
        "ONHOLD": {
          "comment": "Stop processing"
        }
      }
    },
    "232_wait_for_invoice_runs": {
      "comment": "Wait until all invoicing runs are complete",
      "action": "wait_for_workflows",
      "retry_delay": 120,
      "args": {
        "workflow_names": [
          "RUN_INVOICE_BATCH"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "234_wait_for_invoice_runs"
        },
        "FAILED": {
          "next": "233_reschedule_failed_workflows"
        },
        "ONHOLD": {
          "comment": "Stop processing"
        }
      }
    },
    "233_reschedule_failed_workflows": {
      "comment": "Reschedule any failed workflows",
      "retries": 1,
      "action": "resubmit_failed_workflows",
      "retry_delay": 120,
      "args": {
        "workflow_names": [
          "RUN_INVOICE_BATCH"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "232_wait_for_invoice_runs"
        }
      }
    },
    "234_wait_for_invoice_runs": {
      "comment": "Wait until all invoicing runs are complete",
      "action": "wait_for_workflows",
      "retry_delay": 120,
      "args": {
        "acceptable_error_rate": 1,
        "workflow_names": [
          "INVOICEGEN"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120
        },
        "FAILED": {
          "next": "235_reschedule_failed_workflows"
        },
        "ONHOLD": {
          "comment": "Stop processing"
        }
      }
    },
    "235_reschedule_failed_workflows": {
      "comment": "Reschedule any failed workflows",
      "retries": 1,
      "action": "resubmit_failed_workflows",
      "retry_delay": 120,
      "args": {
        "workflow_names": [
          "INVOICEGEN"
        ]
      },
      "on": {
        "COMPLETE": {
          "delay": 120,
          "next": "234_wait_for_invoice_runs"
        }
      }
    },
    "240_extract_results_to_s3": {
      "comment": "Extract the results of the invoice runs to S3"
    },
    "250_scale_down_deployments": {
      "comment": "kubectl -n core scale --replicas=0 deployment --all",
      "action": "scale_replicas",
      "args": {
        "namespace": "core",
        "deployment": [
          "workflow",
          "meterdata"
        ],
        "replicas": 0
      },
      "on": {
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "260_scale_down_nodegroup": {
      "action": "scale_nodegroup",
      "args": {
        "min_size": 0,
        "max_size": 9,
        "desired_size": 0
      },
      "on": {
        "RUNNING": {
          "next": "261_wait_for_scale_down_nodegroup"
        },
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "261_wait_for_scale_down_nodegroup": {
      "action": "wait_for_scale_nodegroup",
      "on": {
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "270_terminate_db_instance": {
      "comment": "Delete the CF stack that created the database"
    }
  }
}
