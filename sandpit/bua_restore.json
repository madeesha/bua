{
  "name": "BUA Restore",
  "this": "000_restore_database",
  "retry_delay": 120,
  "data": {
    "domain": "cmil2mssslzz.ap-southeast-2.rds.amazonaws.com",
    "instance_class": "DBInstanceClassR6i",
    "instance_type": "8xlarge",
    "mysql_version": "8.0.32",
    "params_id": "1",
    "schema": "Turkey_BLU",
    "snapshot_arn": "arn:aws:rds:ap-southeast-2:561082505378:snapshot:tst-anstead-12-bua-sql-mysql8-0-32",
    "suffix": "bua-sql",
    "update_id": "12",
    "rdssecret": "cicd/tst-anstead/rds/bua",
    "hosted_zone_id": "Z06477101FOH3N8B2WK6N",
    "cluster_name": "anstead",
    "node_group_name": "managed-ng-anstead-demand-1-22-v20230914"
  },
  "steps": {
    "240_extract_results_to_s3": {
      "comment": "Extract the results of the invoice runs to S3"
    },
    "250_scale_down_deployments": {
      "comment": "kubectl -n core scale --replicas=0 deployment --all",
      "action": "scale_replicas",
      "args": {
        "namespace": "core",
        "deployment": [
          "workflow",
          "meterdata"
        ],
        "replicas": 0
      },
      "on": {
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "260_scale_down_nodegroup": {
      "action": "scale_nodegroup",
      "args": {
        "min_size": 0,
        "max_size": 1,
        "desired_size": 0
      },
      "on": {
        "RUNNING": {
          "next": "261_wait_for_scale_down_nodegroup"
        },
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "261_wait_for_scale_down_nodegroup": {
      "action": "wait_for_scale_nodegroup",
      "on": {
        "FAILED": {
          "comment": "Failed to scale node group"
        },
        "TERMINATE": {
          "comment": "Failed to scale node group"
        },
        "COMPLETE": {
          "delay": 120
        }
      }
    },
    "270_terminate_db_instance": {
      "comment": "Delete the CF stack that created the database"
    }
  }
}
