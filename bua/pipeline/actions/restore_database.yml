name: Restore Database
this: 01_restore_database
instance: ''
type: sqs
retry_delay: 120
data:
  domain: cmil2mssslzz.ap-southeast-2.rds.amazonaws.com
  instance_class: DBInstanceClassR6i
  instance_type: 8xlarge
  mysql_version: 8.0.32
  params_id: '1'
  schema: Turkey_BLU
  snapshot_arn: arn:aws:rds:ap-southeast-2:561082505378:snapshot:tst-anstead-12-bua-sql-mysql8-0-32
  suffix: bua-sql
  update_id: '12'
  rdssecret: "cicd/tst-anstead/rds/bua"
  hosted_zone_id: "Z06477101FOH3N8B2WK6N"
steps:
  01_restore_database:
    action: restore_database
    'on':
      COMPLETE:
        next: 01_wait_for_restore_database
      FAILED:
        next: 02_destroy_database
    retries: 1
  01_wait_for_restore_database:
    action: check_restore_database
    'on':
      COMPLETE:
        next: 03_reset_rds_password
  02_destroy_database:
    action: destroy_database
    'on':
      COMPLETE:
        next: 02_wait_for_destroy_database
  02_wait_for_destroy_database:
    action: check_destroy_database
    'on':
      COMPLETE:
        next: 01_restore_database
  03_reset_rds_password:
    action: reset_password
    'on':
      COMPLETE:
        delay: 120
        next: 04_disable_workflow_schedules
  04_disable_workflow_schedules:
    action: disable_workflow_schedules
    'on':
      COMPLETE:
        next: 05_disable_workflow_instances
  05_disable_workflow_instances:
    action: disable_workflow_instances
    'on':
      COMPLETE:
        next: 06_set_user_passwords
  06_set_user_passwords:
    comment: set the user passwords
    action: execute_sql
    args:
      sqlsecret: "cicd/tst-anstead/rds/bua/passwords"
    'on':
      COMPLETE:
        next: 07_stats_sample_pages
  07_stats_sample_pages:
    action: stats_sample_pages
    speed: slow
    args:
      tables:
        - name: AggregatedRead
          sample_pages: 1600
    'on':
      COMPLETE:
        next: 08_scale_down_deployments
  08_scale_down_deployments:
    comment: kubectl -n core scale --replicas=0 deployment --all
    action: scale_replicas
    args:
      namespace: core
      deployment: [ workflow , meterdata ]
      replicas: 0
    'on':
      COMPLETE:
        delay: 120
        next: 09_switch_dns
  09_switch_dns:
    comment: need to update route53 entries with the rds server endpoint
    action: set_rds_dns_entry
    args:
      route53_records:
        - name: tst-sql1.anstead.encore.sh
          type: CNAME
    'on':
      COMPLETE:
        delay: 120
        next: 10_scale_up_workflow
  10_scale_up_workflow:
    comment: kubectl -n core scale --replicas=3 deployment workflow
    action: scale_replicas
    args:
      namespace: core
      deployment: [ workflow ]
      replicas: 3
    'on':
      COMPLETE:
        delay: 300
        next: 11_analyse_statistics
  11_analyse_statistics:
    action: core_warm_database_statistics
    args:
      concurrency: 32
    'on':
      COMPLETE:
        delay: 120
        next: 11_wait_for_analyse_statistics
  11_wait_for_analyse_statistics:
    action: wait_for_workflows
    retry_delay: 300
    args:
      workflow_names:
        - WARM_TABLE
        - WARM_PARTITION
    'on':
      COMPLETE:
        next: 12_database_warming
  12_database_warming:
    action: core_warm_database_indexes
    args:
      concurrency: 32
    'on':
      COMPLETE:
        delay: 120
        next: 12_wait_for_database_warming
  12_wait_for_database_warming:
    action: wait_for_workflows
    retry_delay: 300
    args:
      workflow_names:
        - WARM_INDEX
    'on':
      COMPLETE:
        delay: 120
  13_utility_profiles:
    action: bua_initiate
    args:
      run_type: Utility
    'on':
      COMPLETE:
        delay: 120
        next: 13_wait_for_utility_profiles
  13_wait_for_utility_profiles:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
  14_jurisdiction_segments:
    action: bua_initiate
    args:
      run_type: SegmentJurisdictionAvgExclEst
    'on':
      COMPLETE:
        delay: 120
        next: 14_wait_for_jurisdiction_segments
  14_wait_for_jurisdiction_segments:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
  15_segment_jurisdiction_check:
    action: bua_initiate
    arg:
      run_type: SegmentJurisdictionCheck
      identifier_type: SegmentJurisdictionAvgExclEst
    'on':
      COMPLETE:
        delay: 120
        next: 15_wait_for_segment_jurisdiction_check
  15_wait_for_segment_jurisdiction_check:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
  15_profile_validation:
    action: bua_initiate
    args:
      run_type: Validate
    'on':
      COMPLETE:
        delay: 120
        next: 15_wait_for_profile_validation
  15_wait_for_profile_validation:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
  16_resolve_variances:
    comment: bua_resolve_variances
    'on':
      COMPLETE:
        delay: 120
  17_scale_up_meterdata:
    comment: kubectl -n core scale --replicas=6 deployment meterdata
    action: scale_replicas
    args:
      namespace: core
      deployment: [ meterdata ]
      replicas: 6
    'on':
      COMPLETE:
        delay: 120
  18_execute_micro_scalar:
    comment: Generate micro scalar values
    action: bua_initiate
    speed: slow
    args:
      run_type: MicroScalar
      identifier_type: SegmentJurisdictionAvgExclEst
    'on':
      COMPLETE:
        delay: 120
        next: 18_wait_for_execute_micro_scalar
  18_wait_for_execute_micro_scalar:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
  19_generate_NEM12_files:
    comment: Generate the missing electricity interval reads
    action: bua_initiate
    args:
      run_type: NEM12
      identifier_type: SegmentJurisdictionAvgExclEst
    'on':
      COMPLETE:
        delay: 120
        next: 19_wait_for_generate_NEM12_files_1
  19_wait_for_generate_NEM12_files_1:
    action: wait_for_empty_site_queues
    retry_delay: 300
    'on':
      COMPLETE:
        delay: 120
        next: 19_wait_for_generate_NEM12_files_2
  19_wait_for_generate_NEM12_files_2:
    comment: Wait until the aggregation workflows are complete
    action: wait_for_workflows
    retry_delay: 300
    args:
      workflow_names:
        - ImportNem
        - ImportGas
        - AggregateReadNmiDate
        - RegenerateProfile
        - ValidateNEM13Read
    'on':
      COMPLETE:
        delay: 120
  19_generate_missing_elec_basic_reads:
    comment: Generate all of the missing electricity basic reads
  20_generate_missing_gas_reads:
    comment: Generate all of the missing gas reads
  21_invoice_runs:
    comment: Initiate the invoice runs
    action: bua_initiate_invoice_runs
    speed: slow
    'on':
      COMPLETE:
        delay: 120
        next: 21_wait_for_invoice_runs_1
  21_wait_for_invoice_runs_1:
    action: wait_for_workflow_schedules
    args:
      workflow_names:
        - GENERATE_ILI
    'on':
      COMPLETE:
        delay: 120
        next: 21_wait_for_invoice_runs_2
  21_wait_for_invoice_runs_2:
    comment: Wait until all invoicing runs are complete
    action: wait_for_workflows
    retry_delay: 300
    args:
      workflow_names:
        - RUN_INVOICE_BATCH
        - GENERATE_ILI
    'on':
      COMPLETE:
        delay: 120
  22_extract_results_to_s3:
    comment: Extract the results of the invoice runs to S3
  23_scale_down_deployments:
    comment: kubectl -n core scale --replicas=0 deployment --all
    args:
      namespace: core
      deployment: [ workflow , meterdata ]
    'on':
      COMPLETE:
        delay: 120
