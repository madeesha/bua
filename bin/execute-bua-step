#!/bin/bash
# Execute bua process step
set -feuo pipefail

print_syntax() {
  echo ""
  echo "execute-bua-step [name] <steps>"
  echo ""
  echo "run-date format YYYY-MM-DD"
  echo ""
  exit 1
}

check_inputs() {
  echo ""
  echo "==========================="
  echo "Execute a BUA step function"
  echo "==========================="
  echo ""
  echo "Checking arguments $@"
  echo ""
  if [[ $# -lt 1 ]] ; then
    print_syntax
  fi
  if [[ $# -eq 1 ]] ; then
    if [[ "${1}" =~ .*,.* ]] ; then
      echo ""
      echo "You must specify a name if providing multiple steps"
      echo ""
      print_syntax
    fi
  fi
}

check_inputs "$@"

today=$(date +'%Y-%m-%d')
uuid=$(uuid)

name="$1"
steps="${2:-${name}}"

input=$(jq -n --arg stp "${steps}" '{"steps": $stp}')

aws --profile anstead --region ap-southeast-2 stepfunctions start-execution \
    --state-machine-arn arn:aws:states:ap-southeast-2:561082505378:stateMachine:tst-anstead-bua \
    --name "${today}-${name}-${uuid}" \
    --input "${input}"
