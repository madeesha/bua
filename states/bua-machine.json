{
  "Comment": "Bottom Up Accruals",
  "StartAt": "Initialise",
  "States": {
    "Initialise": {
      "Type": "Pass",
      "Parameters": {
        "data": {
        },
        "context": {
          "steps.$": "$.steps"
        }
      },
      "Next": "GetParameters"
    },
    "GetParameters": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${FastControllerFunction}",
        "Payload": {
          "type": "step",
          "name": "BUA",
          "action": "get_parameters",
          "args": {
            "names": [
              "run_date",
              "today",
              "start_inclusive",
              "end_inclusive",
              "end_exclusive",
              "source_date",
              "default_steps"
            ]
          },
          "data.$": "$.data",
          "context.$": "$.context"
        }
      },
      "ResultSelector": {
        "data.$": "$.Payload.data",
        "context.$": "$.Payload.context"
      },
      "TimeoutSeconds": 180,
      "Next": "DefineDefaultSteps"
    },
    "DefineDefaultSteps": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context": {
          "steps.$": "$.context.steps",
          "default_steps.$": "$.data.default_steps",
          "splitter": ","
        }
      },
      "Next": "SplitSteps"
    },
    "SplitSteps": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context": {
          "steps.$": "States.StringSplit($.context.steps, $.context.splitter)",
          "step_count.$": "States.ArrayLength(States.StringSplit($.context.steps, $.context.splitter))",
          "default_steps.$": "States.StringSplit($.context.default_steps, $.context.splitter)"
        }
      },
      "Next": "CheckSteps"
    },
    "CheckSteps": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.context.step_count",
          "NumericEquals": 0,
          "Next": "SetDefaultSteps"
        }
      ],
      "Default": "ListStepFunctions"
    },
    "SetDefaultSteps": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context": {
          "steps.$": "$.context.default_steps"
        }
      },
      "Next": "ListStepFunctions"
    },
    "ListStepFunctions": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context.$": "$.context",
        "stepfunction": {
          "bua-restore": "",
          "bua-utility-profiles": "",
          "bua-empty-queues": "",
          "bua-segments": "",
          "bua-microscalar": "",
          "bua-scaleup-meterdata": "",
          "bua-restart-meterdata": "",
          "bua-nem12": "",
          "bua-reset-basicreads": "",
          "bua-reset-nem12": "",
          "bua-basicreads": "",
          "bua-invoiceruns": "",
          "bua-scaledown": "",
          "bua-scaleup-workflow": "",
          "bua-warming": "",
          "bua-warm-statistics": "",
          "bua-warm-indexes": "",
          "bua-prepare": "",
          "bua-export": "",
          "bua-snapshot": "",
          "bua-destroy": "",
          "bua-clean-invoiceattribute": "",
          "bua-clean-utilityprofile": "",
          "bua-clean-workflows": ""
        }
      },
      "Next": "GetStepfunctionArns"
    },
    "GetStepfunctionArns": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "${FastControllerFunction}",
        "Payload": {
          "type": "step",
          "name": "BUA",
          "action": "get_stepfunction_arns",
          "stepfunction.$": "$.stepfunction",
          "data.$": "$.data",
          "context.$": "$.context"
        }
      },
      "ResultSelector": {
        "data.$": "$.Payload.data",
        "context.$": "$.Payload.context",
        "stepfunction.$": "$.Payload.stepfunction"
      },
      "TimeoutSeconds": 180,
      "Next": "InitialiseStart"
    },
    "InitialiseStart": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context": {
          "stepfunction.$": "$.stepfunction",
          "steps.$": "$.context.steps",
          "steps_left.$": "States.MathAdd(States.ArrayLength($.context.steps),-1)",
          "start.$": "States.ArrayGetItem($.context.steps,0)"
        }
      },
      "Next": "WhatToStart"
    },
    "WhatToStart": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.context.start",
          "StringEquals": "DoNothing",
          "Next": "ExecutionDone"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Restore",
          "Next": "Restore"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "CleanInvoiceAttribute",
          "Next": "CleanInvoiceAttribute"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "CleanUtilityProfile",
          "Next": "CleanUtilityProfile"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "CleanWorkflows",
          "Next": "CleanWorkflows"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "EmptyQueues",
          "Next": "EmptyQueues"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "ScaleUpWorkflow",
          "Next": "ScaleUpWorkflow"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Warming",
          "Next": "Warming"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "WarmStatistics",
          "Next": "WarmStatistics"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "WarmIndexes",
          "Next": "WarmIndexes"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "UtilityProfiles",
          "Next": "UtilityProfiles"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Segments",
          "Next": "Segments"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Microscalar",
          "Next": "Microscalar"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "ScaleUpMeterdata",
          "Next": "ScaleUpMeterdata"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "RestartMeterdata",
          "Next": "RestartMeterdata"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "ResetNEM12",
          "Next": "ResetNEM12"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "GenerateNEM12",
          "Next": "GenerateNEM12"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "ResetBasicReads",
          "Next": "ResetBasicReads"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "BasicReads",
          "Next": "BasicReads"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "InvoiceRuns",
          "Next": "InvoiceRuns"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Prepare",
          "Next": "Prepare"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Snapshot",
          "Next": "Snapshot"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Export",
          "Next": "Export"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "ScaleDown",
          "Next": "ScaleDown"
        },
        {
          "Variable": "$.context.start",
          "StringEquals": "Destroy",
          "Next": "Destroy"
        }
      ],
      "Default": "ExecutionFailed"
    },
    "Restore": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-restore",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "CleanInvoiceAttribute": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-clean-invoiceattribute",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "CleanUtilityProfile": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-clean-utilityprofile",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "CleanWorkflows": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-clean-workflows",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "EmptyQueues": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-empty-queues",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "ScaleUpWorkflow": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-scaleup-workflow",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Warming": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-warming",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "WarmStatistics": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-warm-statistics",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "WarmIndexes": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-warm-indexes",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "UtilityProfiles": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-utility-profiles",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Segments": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-segments",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Microscalar": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-microscalar",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "ScaleUpMeterdata": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-scaleup-meterdata",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "RestartMeterdata": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-restart-meterdata",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "ResetNEM12": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$": "$.context.stepfunction.bua-reset-nem12",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "GenerateNEM12": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-nem12",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "ResetBasicReads": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$": "$.context.stepfunction.bua-reset-basicreads",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "BasicReads": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-basicreads",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "InvoiceRuns": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-invoiceruns",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Prepare": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-prepare",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Snapshot": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-snapshot",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Export": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-export",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "ScaleDown": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-scaledown",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "Destroy": {
      "Type": "Task",
      "Resource": "arn:aws:states:::states:startExecution.sync:2",
      "Parameters":{
        "Input":{
          "data.$": "$.data",
          "context.$": "$.context",
          "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
        },
        "StateMachineArn.$":"$.context.stepfunction.bua-destroy",
        "Name.$": "States.Format('{}-{}', $.data.run_date, States.UUID())"
      },
      "ResultSelector": {
        "data.$": "$.Output.data",
        "context.$": "$.Input.context"
      },
      "Next": "IsAnotherStep"
    },
    "IsAnotherStep": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.context.steps_left",
          "NumericGreaterThan": 0,
          "Next": "TakeAStep"
        }
      ],
      "Default": "ExecutionDone"
    },
    "TakeAStep": {
      "Type": "Pass",
      "Parameters": {
        "data.$": "$.data",
        "context": {
          "stepfunction.$": "$.context.stepfunction",
          "steps.$": "$.context.steps[1:]",
          "steps_left.$": "States.MathAdd($.context.steps_left, -1)",
          "start.$": "States.ArrayGetItem($.context.steps, 1)"
        }
      },
      "Next": "WhatToStart"
    },
    "ExecutionFailed": {
      "Type": "Fail",
      "Cause": "Step failed"
    },
    "ExecutionDone": {
      "Type": "Succeed"
    }
  }
}
